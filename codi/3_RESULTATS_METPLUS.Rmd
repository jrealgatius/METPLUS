---
title: 'eControl Met +: Study about the results of the addition of a sulfonylurea, DPP4 inhibitors or SGLT2 inhibitors as a second antidiabetic drug in patients with diabetes mellitus type 2 in treatment with metformin and insufficient glycemic control. Analysis: *`r params$analisis`*'
author: "Jordi Real"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
params: 
  arxiu_Rdata: "Output_metplusOT.RData"
  analisis: "Intention to treat (ITT)"
---


```{r setup, echo=F, include=F}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")


# rm(list=ls())
# memory.size(max=160000)

# Parametres
# output_Rdata<-here::here("resultats","Output_metplus.RData")
conductor_variables<-here::here("variables_metplus.xls")

# Càrrega de libreries i funcions  --------------
library(compareGroups)

link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# Carrega Rdata
load(here::here("resultats",params$arxiu_Rdata))

```

```{r calculs, include=F}
# Generar variable grup indicadora (en relació a la resta)

dades<-make_dummies(dades,"grup","grup_")



```



```{r generacio_taules, echo=F, include=F}

dades<-etiquetar(dades,taulavariables = conductor_variables)

# 10.1 Taules descriptives exploratories  ----------------
taules<-llistadetaules.compare(tablero=c("table1","table2","table3","table4"),y="grup",variables = conductor_variables,dt=dades)

formula<-formula_compare(x="table1",y="grup",taulavariables = conductor_variables)
taula1.post<-descrTable(formula,data=dades,show.p.overall = F)

# 10.2.Taula events -----------
formula<-formula_compare(x="table5",y="grup",taulavariables = conductor_variables,dt=dades)
taula_events<-descrTable(formula,data=dades, show.ratio = T)


```

# Study Objectives and Endpoints:

## The primary objective:

To compare the proportion of patients achieving the reduction in HbA1c values of at least 0.5%, a weight reduction of at least 3%, after the addition of a SU, an DPP-4i or an SGLT-2i to the treatment with metformin in patients with T2DM and insufficient glycemic control in the medium-long term, up to a maximum of 24 months of follow-up. 

***

## Secondary objectives: 

- To estimate the mean reduction of HbA1c and body weight separately after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control (up to 24 months).
- To assess the average reduction in systolic blood pressure after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control.
- To assess the evolution of lipid profile (mean total cholesterol, HDL, LDL, and triglycerides) after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient control glycemic. 
- To assess  the adherence to treatment after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control.
- To assess  the percentage of suspensions/dropouts of treatment at 6, 12 and 24 months (persistence of treatment).
- To describe the relevant adverse reactions produced after the addition of an SU, an DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control.
- To describe the comorbidity profile and baseline clinical characteristics of patients with DM2 and insufficient control with metformin in monotherapy after addition of a treatment with SU, DPP-4i or SGLT-2i.
- To describe the clinical characteristics of patients who have the best efficacy results (patients with a reduction of HbA1c of more than 0.5% and a weight reduction of at least 3% before the end of follow-up).

***

# Flow chart    

```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}


# flow_global

flow_global2


```

# Pre-post descriptive analysis 

```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

export2md(taula1, caption = "Table 1: Sociodemographic variables pre matching (N=75808)")

export2md(taulaPS, caption = "Table 1: Sociodemographic variables post matching (N=6577)")



```

# Descriptive analysis

```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

export2md(taules[[1]], caption = "Table 1: Sociodemographic variables")

export2md(taules[[2]], caption = "Table 2: Baseline comorbidity variables")

export2md(taules[[3]], caption = "Clinical variables related to T2DM")




```

# Primary objective

To compare the proportion of patients achieving the reduction in HbA1c values of at least 0.5%, a weight reduction of at least 3%, after the addition of a SU, an DPP-4i or an SGLT-2i to the treatment with metformin in patients with T2DM and insufficient glycemic control in the medium-long term, up to a maximum of 24 months of follow-up. 


```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

formula<-formula_compare(x="outcomes1",y="grup",taulavariables = conductor_variables)

descrTable(formula,data=dades,show.p.mul = T) %>% 
  export2md(caption = "Variables related to treatment efficacy")




```

## Odds Ratio de reducción de HBA1C en relación a un grupo de referencia (IDPP4) crudo y ajustado

```{r OR_REDUC_HB, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}


##################  Odds Ratio HBA1C.dif324m.cat       --------
# OR's cru
outcome<-"HBA1C.dif324m.cat"


model<-extreure_model_logistic(x="grup",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")

model$taula_OR %>% head(2) %>%
  kable(caption = paste0("Odds ratio reducción de HBA1C ajustados por: ",paste0(extreure.variables("grup",conductor_variables),collapse = ", "),digits = 3)) %>%
  kableExtra::kable_styling()

# Ajustat
model<-extreure_model_logistic("grup_ajustat",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")

model$taula_OR %>% head(2) %>%
  kable(caption = paste0("OR ajustados por:",paste0(extreure.variables("grup_ajustat",conductor_variables),collapse = ", ")),digits = 3) %>%
  kableExtra::kable_styling()



```

## Odds Ratio de reducción de HBA1C de cada grupo en relación al resto

```{r ORGLOBAL_REDUC_HB, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

##################  Odds RatioS HBA1C.dif324m.cat       --------
# OR's cru
outcome<-"HBA1C.dif324m.cat"

model1<-extreure_model_logistic(x="grupIDPP4",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model2<-extreure_model_logistic(x="grupSU",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model3<-extreure_model_logistic(x="grupISGLT2",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
models<-model1 %>% rbind(model2) %>% rbind(model3)

titul<-paste0("Odds ratio crudos de reducción de HBA1C de cada grupo en relación al resto")

models %>%
  kable(caption = titul,digits = 3) %>%
  kableExtra::kable_styling()


# OR's ajustats
model1<-extreure_model_logistic(x="grupIDPP4_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model2<-extreure_model_logistic(x="grupSU_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model3<-extreure_model_logistic(x="grupISGLT2_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 

models<-model1 %>% rbind(model2) %>% rbind(model3)

titul<-paste0("Odds ratio crudos de reducción de HBA1C de cada grupo en relación al resto. Ajustato por:",paste0(extreure.variables("grup_ajustat",conductor_variables),collapse = ", "))

models %>%
  kable(caption = titul,digits = 3) %>%
  kableExtra::kable_styling()


```

## Odds Ratio de reducción de PESO en relación a un grupo de referencia (IDPP4) crudo y ajustado

```{r ORPESO, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}
##################  Odds Ratio  PESO.dif324m.cat      --------
# OR's cru
outcome<-"PESO.dif324m.cat"

model<-extreure_model_logistic("grup",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")

model$taula_OR %>% head(2) %>%
  kable(caption = paste0("OR de reducción de peso ajustados por:",paste0(extreure.variables("grup",conductor_variables),collapse = ", ")),digits = 3) %>%kableExtra::kable_styling()


# ORs ajustat
model<-extreure_model_logistic("grup_ajustat",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")

model$taula_OR %>% head(2) %>% mutate_if(is.numeric, format, digits=3) %>% 
  kable(caption = paste0("OR de reducción ajustados por:",paste0(extreure.variables("grup_ajustat",conductor_variables),collapse = ", ")),digits = 3) %>%   
  kableExtra::kable_styling()


```


## Odds Ratio de reducción de PESO de cada grupo en relación al resto

```{r OR2_PESO, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

##################  Odds RatioS HBA1C.dif324m.cat       --------
# OR's cru
outcome<-"PESO.dif324m.cat"

model1<-extreure_model_logistic(x="grupIDPP4",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model2<-extreure_model_logistic(x="grupSU",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model3<-extreure_model_logistic(x="grupISGLT2",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
models<-model1 %>% rbind(model2) %>% rbind(model3)

titul<-paste0("Odds ratio crudos de reducción de PESO de cada grupo en relación al resto")

models %>%
  kable(caption = titul,digits = 4) %>%
  kableExtra::kable_styling()


# OR's ajustats
model1<-extreure_model_logistic(x="grupIDPP4_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model2<-extreure_model_logistic(x="grupSU_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model3<-extreure_model_logistic(x="grupISGLT2_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 

models<-model1 %>% rbind(model2) %>% rbind(model3)

titul<-paste0("Odds ratio crudos de reducción de PESO de cada grupo en relación al resto. Ajustato por:",paste0(extreure.variables("grup_ajustat",conductor_variables),collapse = ", "))

models %>%
  kable(caption = titul,digits = 4) %>%
  kableExtra::kable_styling()


```

## Odds Ratio de reducción de HBA1C + Peso de cada grupo en relación a IDPP4

```{r ORPES_HB_REDUCCIO, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}
##################  Odds Ratio  PESHB.dif324m.cat      --------
# OR's cru
outcome<-"PESHB.dif324m.cat"


model<-extreure_model_logistic("grup",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")
model$taula_OR %>% head(2) %>% 
  kable(caption = paste0("Odds ratio reducción de peso y HBA1C ajustados por:",paste0(extreure.variables("grup",conductor_variables),collapse = ", ")),digits = 4) %>%   
  kableExtra::kable_styling()

# Ajustat 
model<-extreure_model_logistic("grup_ajustat",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")
model$taula_OR %>% head(2) %>% 
  kable(caption = paste0("Odds ratio reducción de peso y HBA1C ajustados por:",paste0(extreure.variables("grup_ajustat",conductor_variables),collapse = ", ")),digits = 4) %>%   
  kableExtra::kable_styling()
```


## Odds Ratio de reducción de PESO de cada grupo en relación al resto

```{r OR2PES_HB_REDUCCIO, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

##################  Odds RatioS HBA1C.dif324m.cat       --------
# OR's cru
outcome<-"PESHB.dif324m.cat"

model1<-extreure_model_logistic(x="grupIDPP4",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model2<-extreure_model_logistic(x="grupSU",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model3<-extreure_model_logistic(x="grupISGLT2",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
models<-model1 %>% rbind(model2) %>% rbind(model3)

titul<-paste0("Odds ratio crudos de reducción de PESO Y HB de cada grupo en relación al resto")

models %>%
  kable(caption = titul,digits = 3) %>%
  kableExtra::kable_styling()


# OR's ajustats
model1<-extreure_model_logistic(x="grupIDPP4_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model2<-extreure_model_logistic(x="grupSU_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 
model3<-extreure_model_logistic(x="grupISGLT2_adj",y=outcome,taulavariables = conductor_variables,dades=dades,valor_outcome = "Yes")$taula_OR %>% head(1) 

models<-model1 %>% rbind(model2) %>% rbind(model3)

titul<-paste0("Odds ratio crudos de reducción de PESO Y HB de cada grupo en relación al resto. Ajustato por:",paste0(extreure.variables("grup_ajustat",conductor_variables),collapse = ", "))

models %>%
  kable(caption = titul,digits = 3) %>%
  kableExtra::kable_styling()


```

# Secondary objectives


- To estimate the mean reduction of HbA1c and body weight separately after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control (up to 24 months).


```{r outcomes_secundaris, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

# Outcomes continus 

# Diferencies crues
model<-extreure_coef_glm(dt=dades,outcomes = "outcomes_continus",x="grup",z="",taulavariables = conductor_variables)

model$coef %>% kable(caption=paste0("Betas",model$caption),digits=3) %>% 
  kableExtra::kable_styling()

# Diferencies ajustades
model<-extreure_coef_glm(dt=dades,outcomes = "outcomes_continus",x="grup",z="v.ajust",taulavariables = conductor_variables)

# Etiquetar coeficients
model$coef<-model$coef %>% etiquetar_taula(camp = "Outcome",conductor_variables)

# Mostrar coeficients
model$coef %>% kable(caption=paste0("Betas",model$caption),digits=3) %>% 
  kableExtra::kable_styling()


```

- To assess the average reduction in systolic blood pressure after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control.


```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}
formula<-formula_compare("table6",y="grup",taulavariables = conductor_variables)
descrTable(formula,dades) %>% 
  export2md(caption = "Secondary variables related to treatment efficacy")

# Diferencies crues
model<-extreure_coef_glm(dt=dades,outcomes = "table6",x="grup",z="",taulavariables = conductor_variables)
# Etiquetar coeficients
model$coef<-model$coef %>% etiquetar_taula(camp = "Outcome",conductor_variables)
model$coef %>% kable(caption=paste0("Betas",model$caption),digits=3) %>% 
  kableExtra::kable_styling()

# Diferencies ajustades
model<-extreure_coef_glm(dt=dades,outcomes = "table6",x="grup",z="v.ajust",taulavariables = conductor_variables)
# Etiquetar coeficients
model$coef<-model$coef %>% etiquetar_taula(camp = "Outcome",conductor_variables)
# Mostrar taula
model$coef %>% kable(caption=paste0("Betas",model$caption),digits=3) %>% 
  kableExtra::kable_styling()


```

- To assess the evolution of lipid profile (mean total cholesterol, HDL, LDL, and triglycerides) after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient control glycemic. 


```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

formula<-formula_compare("table7",y="grup",taulavariables = conductor_variables)
descrTable(formula,dades) %>% 
  export2md(caption = "Secondary variables related to treatment efficacy")


# Diferencies crues
model<-extreure_coef_glm(dt=dades,outcomes = "table7",x="grup",z="",taulavariables = conductor_variables)
# Etiquetar coeficients
model$coef<-model$coef %>% etiquetar_taula(camp = "Outcome",conductor_variables)
model$coef %>% kable(caption=paste0("Betas",model$caption),digits=3) %>% 
  kableExtra::kable_styling()

# Diferencies ajustades
model<-extreure_coef_glm(dt=dades,outcomes = "table7",x="grup",z="v.ajust",taulavariables = conductor_variables)
model$coef %>% kable(caption=paste0("Betas",model$caption),digits=3) %>% 
  kableExtra::kable_styling()


```

- To assess  the adherence to treatment after the addition of an SU, a DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control.


```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

formula<-formula_compare("table8",y="grup",taulavariables = conductor_variables)
descrTable(formula,dades) %>% 
  export2md(caption = "Adherence to  treatment 24m post")

```

- To assess  the percentage of suspensions/dropouts of treatment at 6, 12 and 24 months.

```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

formula<-formula_compare("table9",y="grup",taulavariables = conductor_variables)
descrTable(formula,dades) %>% 
  export2md(caption = "Percentage of suspensions/dropouts of treatment at 6, 12 and 24")

# descrTable(STOP.FD_surv~grup,data=dades)
# descrTable(STOP.FD_surv~grup,data=dades, show.ratio = T)

survminer::ggsurvplot(survfit(STOP.FD_surv ~ grup, data = dades), data = dades,
                  main = "Survival curve",
                  title= "Suspensions/dropouts during follow-up before 24 months",
                  size = 0.5,
                  ylim = c(0,1),
                  xlim = c(0,730),
                  break.x.by=180,
                  xlab = "Time in days",
                  risk.table = F,
                  censor.shape="|", censor.size = 1)



```

- To describe the relevant adverse reactions produced after the addition of an SU, an DPP-4i or an SGLT-2i in patients with DM2 treated with metformin and insufficient glycemic control.


```{r, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

descrTable(EV.AMPU.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.CETO.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.FRAC.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.GI.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.NEOGAST.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.RAD.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.RAH.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.RAHEM.surv ~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()
descrTable(EV.RAR.surv~grup,data=dades, show.ratio = F,show.p.overall = F) %>% export2md()


```

- To describe the comorbidity profile and baseline clinical characteristics of patients with DM2 and insufficient control with metformin in monotherapy after addition of a treatment with SU, DPP-4i or SGLT-2i.

```{r}

```

- To describe the clinical characteristics of patients who have the best efficacy results (patients with a reduction of HbA1c of more than 0.5% and a weight reduction of at least 3% before the end of follow-up).



```{r}

```

